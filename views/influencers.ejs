    <%- include('./navbar') %>

<!-- Success/Error Messages -->
<% if (typeof success !== 'undefined') { %>
<div style="background-color:#d1e7dd; color:#0f5132; border:1px solid #badbcc; padding:10px; border-radius:6px; margin-bottom:15px; position:relative;">
  <%= success %>
  <button type="button" onclick="this.parentElement.remove()" 
          style="position:absolute; right:10px; top:10px; background:none; border:none; font-size:16px; cursor:pointer;">√ó</button>
</div>
<% } %>

<% if (typeof error !== 'undefined') { %>
<div style="background-color:#f8d7da; color:#842029; border:1px solid #f5c2c7; padding:10px; border-radius:6px; margin-bottom:15px; position:relative;">
  <%= error %>
  <button type="button" onclick="this.parentElement.remove()" 
          style="position:absolute; right:10px; top:10px; background:none; border:none; font-size:16px; cursor:pointer;">√ó</button>
</div>
<% } %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
  <p style="color:#6c757d; margin:0;">Manage influencers and referral codes</p>
  <button style="background-color:#0d6efd; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;"
          onclick="document.getElementById('createInfluencerModal').style.display='block'">
    ‚ûï Create New Influencer
  </button>
</div>

<div style="background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:20px;">
  <div style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background-color:#f1f3f5; text-align:left;">
          <th style="padding:10px;">Name</th>
          <th style="padding:10px;">Referral Code</th>
          <th style="padding:10px;">Discount (%)</th>
          <th style="padding:10px;">Status</th>
          <th style="padding:10px;">Created</th>
          <th style="padding:10px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% influencers.forEach(influencer => { %>
        <tr style="border-bottom:1px solid #ddd;">
          <td style="padding:10px; font-weight:bold;"><%= influencer.name %></td>
          <td style="padding:10px;"><span style="background:#0dcaf0; color:white; padding:3px 8px; border-radius:4px;"><%= influencer.referral_code %></span></td>
          <td style="padding:10px;"><%= influencer.discount_percent %>%</td>
          <td style="padding:10px;">
            <% if (influencer.is_active) { %>
              <span style="background:#198754; color:white; padding:3px 8px; border-radius:4px;">Active</span>
            <% } else { %>
              <span style="background:#6c757d; color:white; padding:3px 8px; border-radius:4px;">Inactive</span>
            <% } %>
          </td>
          <td style="padding:10px;"><%= new Date(influencer.created_at).toLocaleDateString() %></td>
          <td style="padding:10px;">
            <div style="display:flex; gap:5px;">
              <!-- Edit Button -->
              <button onclick="editInfluencer(<%= influencer.id %>, '<%= influencer.name %>', '<%= influencer.referral_code %>', <%= influencer.discount_percent %>, <%= influencer.is_active %>)" 
                      style="border:1px solid #0d6efd; color:#0d6efd; background:none; padding:4px 8px; border-radius:4px; cursor:pointer;" 
                      title="Edit">‚úèÔ∏è</button>
              
              <!-- Toggle Active Status -->
              <form method="POST" action="/admin/influencers/<%= influencer.id %>/toggle" style="display:inline;" 
                    onsubmit="return confirm('Are you sure you want to <%= influencer.is_active ? 'deactivate' : 'activate' %> this influencer?')">
                <button type="submit" 
                        style="border:1px solid #ffc107; color:#ffc107; background:none; padding:4px 8px; border-radius:4px; cursor:pointer;" 
                        title="<%= influencer.is_active ? 'Deactivate' : 'Activate' %>">
                  <%= influencer.is_active ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è" %>
                </button>
              </form>
              
              <!-- Delete Button -->
              <form method="POST" action="/admin/influencers/<%= influencer.id %>/delete" style="display:inline;" 
                    onsubmit="return confirm('Are you sure you want to delete this influencer? This action cannot be undone.')">
                <button type="submit" 
                        style="border:1px solid #dc3545; color:#dc3545; background:none; padding:4px 8px; border-radius:4px; cursor:pointer;" 
                        title="Delete">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>

<!-- Create Influencer Modal -->
<div id="createInfluencerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:400px; margin:10% auto; border-radius:8px; overflow:hidden;">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <h5 style="margin:0;">Create New Influencer</h5>
      <button onclick="document.getElementById('createInfluencerModal').style.display='none'" 
              style="background:none; border:none; font-size:18px; cursor:pointer;">√ó</button>
    </div>
    <form action="/admin/influencers/create" method="POST" style="padding:15px;">
      <div style="margin-bottom:10px;">
        <label>Name *</label>
        <input type="text" name="name" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label>Referral Code *</label>
        <input type="text" name="referral_code" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
        <small style="color:#6c757d;">Unique code for sharing (e.g., SAVE20)</small>
      </div>
      <div style="margin-bottom:10px;">
        <label>Discount (%) *</label>
        <input type="number" name="discount_percent" min="0" max="100" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label><input type="checkbox" name="is_active" checked> Active</label>
      </div>
      <div style="text-align:right;">
        <button type="button" onclick="document.getElementById('createInfluencerModal').style.display='none'" 
                style="background:#6c757d; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cancel</button>
        <button type="submit" 
                style="background:#0d6efd; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Create Influencer</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Influencer Modal -->
<div id="editInfluencerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:400px; margin:10% auto; border-radius:8px; overflow:hidden;">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <h5 style="margin:0;">Edit Influencer</h5>
      <button onclick="document.getElementById('editInfluencerModal').style.display='none'" 
              style="background:none; border:none; font-size:18px; cursor:pointer;">√ó</button>
    </div>
    <form id="editInfluencerForm" method="POST" style="padding:15px;">
      <div style="margin-bottom:10px;">
        <label>Name *</label>
        <input type="text" name="name" id="editInfluencerName" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label>Referral Code *</label>
        <input type="text" name="referral_code" id="editInfluencerCode" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label>Discount (%) *</label>
        <input type="number" name="discount_percent" id="editInfluencerDiscount" min="0" max="100" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label><input type="checkbox" name="is_active" id="editInfluencerActive"> Active</label>
      </div>
      <div style="text-align:right;">
        <button type="button" onclick="document.getElementById('editInfluencerModal').style.display='none'" 
                style="background:#6c757d; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cancel</button>
        <button type="submit" 
                style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Update Influencer</button>
      </div>
    </form>
  </div>
</div>

<script>
// Show messages from URL
const urlParams = new URLSearchParams(window.location.search);
const successMsg = urlParams.get('success');
const errorMsg = urlParams.get('error');

function showAlert(msg, color) {
  const div = document.createElement('div');
  div.style.cssText = `background-color:${color === 'success' ? '#d1e7dd':'#f8d7da'}; 
                       color:${color === 'success' ? '#0f5132':'#842029'};
                       border-radius:6px; padding:10px; margin-bottom:15px; position:relative;`;
  div.innerHTML = msg + `<button onclick="this.parentElement.remove()" 
                          style='position:absolute; right:10px; top:10px; background:none; border:none; cursor:pointer;'>√ó</button>`;
  const container = document.querySelector('div[style*="display:flex"]');
  if(container) container.parentNode.insertBefore(div, container);
}

if (successMsg) showAlert(successMsg, 'success');
if (errorMsg) showAlert(errorMsg, 'error');

// Edit Influencer Function
function editInfluencer(id, name, code, discount, isActive) {
  document.getElementById('editInfluencerForm').action = `/admin/influencers/${id}/update`;
  document.getElementById('editInfluencerName').value = name;
  document.getElementById('editInfluencerCode').value = code;
  document.getElementById('editInfluencerDiscount').value = discount;
  document.getElementById('editInfluencerActive').checked = isActive;
  document.getElementById('editInfluencerModal').style.display = 'block';
}

// Close modals when clicking outside
window.onclick = function(event) {
  const createModal = document.getElementById('createInfluencerModal');
  const editModal = document.getElementById('editInfluencerModal');
  
  if (event.target === createModal) {
    createModal.style.display = 'none';
  }
  if (event.target === editModal) {
    editModal.style.display = 'none';
  }
}
</script>
