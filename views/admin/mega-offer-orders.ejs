<!DOCTYPE html>
<html lang="en">

<head>

    <style>
        .filter-card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: linear-gradient(145deg, #ffffff, #f5f7fa);
        }

        .table-responsive {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .table thead th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            border: none;
        }
    </style>
</head>

<body class="bg-light">
    <%- include('../navbar') %>

        <div class="container-fluid py-5 px-lg-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800 fw-bold">üéÅ Mega Offer Orders</h1>
                    <p class="text-muted small mb-0">Manage claims and mystery gifts orders</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="card filter-card mb-4">
                <div class="card-body">
                    <form method="GET" action="/admin/mega-offer-orders" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Festival</label>
                            <select name="festival_id" class="form-select">
                                <option value="">All Festivals</option>
                                <% festivals.forEach(f=> { %>
                                    <option value="<%= f.id %>" <%=filters.festival_id==f.id ? 'selected' : '' %>><%=
                                            f.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Order Type</label>
                            <select name="order_type" class="form-select">
                                <option value="">All Types</option>
                                <option value="win_claim" <%=filters.order_type==='win_claim' ? 'selected' : '' %>>Win
                                    Claim</option>
                                <option value="mystery_gift" <%=filters.order_type==='mystery_gift' ? 'selected' : '' %>
                                    >Mystery Gift</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Payment Status</label>
                            <select name="payment_status" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="paid" <%=filters.payment_status==='paid' ? 'selected' : '' %>>Paid
                                </option>
                                <option value="pending" <%=filters.payment_status==='pending' ? 'selected' : '' %>
                                    >Pending</option>
                                <option value="failed" <%=filters.payment_status==='failed' ? 'selected' : '' %>>Failed
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Search User</label>
                            <!-- Could add a user search logic here later, simplifying for now -->
                            <button type="submit" class="btn btn-primary w-100 mt-4"><i
                                    class="fas fa-filter me-2"></i>Filter</button>
                        </div>
                        <div class="col-md-2">
                            <a href="/admin/mega-offer-orders" class="btn btn-outline-secondary w-100 mt-4"><i
                                    class="fas fa-undo me-2"></i>Reset</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th class="py-3 ps-4">Order ID</th>
                                    <th class="py-3">User Details</th>
                                    <th class="py-3">Festival / Product</th>
                                    <th class="py-3">Type</th>
                                    <th class="py-3 text-end">Details</th>
                                    <th class="py-3 text-center">Payment</th>
                                    <th class="py-3 text-center">Shipping</th>
                                    <th class="py-3 pe-4">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (orders.length> 0) { %>
                                    <% orders.forEach(order=> { %>
                                        <tr>
                                            <td class="ps-4 fw-bold">#<%= order.id %>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="ms-2">
                                                        <h6 class="mb-0 small fw-bold">
                                                            <%= order.user ? (order.user.first_name + ' ' +
                                                                order.user.last_name) : 'N/A' %>
                                                        </h6>
                                                        <small class="text-muted d-block">
                                                            <%= order.user?.email %>
                                                        </small>
                                                        <small class="text-muted d-block">
                                                            <%= order.user?.phone_number %>
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-light text-dark mb-1 d-block text-start text-truncate"
                                                    style="max-width: 200px;">
                                                    <%= order.festival?.name %>
                                                </span>
                                                <span class="small fw-bold text-primary">
                                                    <%= order.product?.name %>
                                                </span>
                                            </td>
                                            <td>
                                                <% if (order.order_type==='win_claim' ) { %>
                                                    <span
                                                        class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Win
                                                        Claim üèÜ</span>
                                                    <% } else { %>
                                                        <span
                                                            class="badge bg-info bg-opacity-10 text-info rounded-pill px-3">Mystery
                                                            Gift üéÅ</span>
                                                        <% } %>
                                            </td>
                                            <td class="text-end font-monospace small">
                                                <div class="text-muted">Orig: ‚Çπ<%= order.original_price %>
                                                </div>
                                                <div class="text-muted">Pre: -‚Çπ<%= order.pre_booking_amount %>
                                                </div>
                                                <% if(order.discount_amount> 0) { %>
                                                    <div class="text-success">Disc: -‚Çπ<%= order.discount_amount %>
                                                    </div>
                                                    <% } %>
                                                        <div class="fw-bold border-top mt-1 pt-1">Paid: ‚Çπ<%=
                                                                order.final_amount_paid %>
                                                        </div>
                                            </td>
                                            <td class="text-center">
                                                <form action="/admin/mega-offer-orders/update-status" method="POST"
                                                    class="d-inline-block">
                                                    <input type="hidden" name="order_id" value="<%= order.id %>">
                                                    <select name="payment_status" class="form-select form-select-sm"
                                                        style="width: auto; display: inline-block;"
                                                        onchange="this.form.submit()">
                                                        <option value="pending" <%=order.payment_status==='pending'
                                                            ? 'selected' : '' %>>Pending</option>
                                                        <option value="paid" <%=order.payment_status==='paid'
                                                            ? 'selected' : '' %>>Paid</option>
                                                        <option value="failed" <%=order.payment_status==='failed'
                                                            ? 'selected' : '' %>>Failed</option>
                                                    </select>
                                                </form>
                                                <% if(order.payment_reference) { %>
                                                    <small class="d-block text-muted mt-1"
                                                        style="font-size: 0.7em;">Ref: <%=
                                                            order.payment_reference.substring(0, 10) %>...</small>
                                                    <% } %>
                                            </td>
                                            <td class="text-center">
                                                <form action="/admin/mega-offer-orders/update-status" method="POST"
                                                    class="d-inline-block">
                                                    <input type="hidden" name="order_id" value="<%= order.id %>">
                                                    <select name="shipping_status" class="form-select form-select-sm"
                                                        style="width: auto; display: inline-block;"
                                                        onchange="this.form.submit()">
                                                        <option value="processing"
                                                            <%=order.shipping_status==='processing' ? 'selected' : '' %>
                                                            >Processing</option>
                                                        <option value="shipped" <%=order.shipping_status==='shipped'
                                                            ? 'selected' : '' %>>Shipped</option>
                                                        <option value="delivered" <%=order.shipping_status==='delivered'
                                                            ? 'selected' : '' %>>Delivered</option>
                                                    </select>
                                                </form>
                                            </td>
                                            <td class="text-end pe-4">
                                                <div class="text-muted small mb-2">
                                                    <%= new Date(order.created_at).toLocaleDateString() %>
                                                </div>
                                                <!-- View User Button -->
                                                <button type="button" class="btn btn-sm btn-outline-info"
                                                    data-bs-toggle="modal" data-bs-target="#userModal<%= order.id %>">
                                                    <i class="fas fa-user-circle"></i> Info
                                                </button>

                                                <!-- User Modal -->
                                                <div class="modal fade" id="userModal<%= order.id %>" tabindex="-1"
                                                    aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content text-start">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">User Details - <%=
                                                                        order.user?.first_name %>
                                                                        <%= order.user?.last_name %>
                                                                </h5>
                                                                <button type="button" class="btn-close"
                                                                    data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <p><strong>Email:</strong>
                                                                    <%= order.user?.email %>
                                                                </p>
                                                                <p><strong>Phone:</strong>
                                                                    <%= order.user?.phone_number %>
                                                                </p>
                                                                <hr>
                                                                <h6>Saved Addresses</h6>
                                                                <% if (order.user?.Addresses &&
                                                                    order.user.Addresses.length> 0) { %>
                                                                    <ul class="list-group list-group-flush">
                                                                        <% order.user.Addresses.forEach(addr=> { %>
                                                                            <li class="list-group-item px-0">
                                                                                <span class="badge bg-secondary mb-1">
                                                                                    <%= addr.type || 'Address' %>
                                                                                </span><br>
                                                                                <%= addr.address_line1 %>, <%=
                                                                                        addr.address_line2 ?
                                                                                        addr.address_line2 + ', ' : ''
                                                                                        %><br>
                                                                                        <%= addr.city %>, <%= addr.state
                                                                                                %> - <%= addr.zip_code
                                                                                                    %><br>
                                                                                                    <%= addr.country %>
                                                                            </li>
                                                                            <% }) %>
                                                                    </ul>
                                                                    <% } else { %>
                                                                        <p class="text-muted">No saved addresses found.
                                                                        </p>
                                                                        <% } %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        <% }) %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="8" class="text-center py-5">
                                                        <div class="text-muted">
                                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                                            <p class="mb-0">No orders found.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <% if (totalPages> 1) { %>
                        <div class="card-footer bg-white border-0 py-3">
                            <nav>
                                <ul class="pagination justify-content-center mb-0">
                                    <% const buildUrl=(p)=> {
                                        const params = new URLSearchParams(filters);
                                        params.set('page', p);
                                        return '/admin/mega-offer-orders?' + params.toString();
                                        };
                                        %>
                                        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                            <a class="page-link rounded-circle mx-1"
                                                href="<%= buildUrl(currentPage - 1) %>"><i
                                                    class="fas fa-chevron-left"></i></a>
                                        </li>
                                        <% for(let i=1; i <=totalPages; i++) { %>
                                            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                                <a class="page-link rounded-circle mx-1 shadow-sm"
                                                    href="<%= buildUrl(i) %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                            <% } %>
                                                <li
                                                    class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                                    <a class="page-link rounded-circle mx-1"
                                                        href="<%= buildUrl(currentPage + 1) %>"><i
                                                            class="fas fa-chevron-right"></i></a>
                                                </li>
                                </ul>
                            </nav>
                        </div>
                        <% } %>
                </div>
            </div>
        </div>

        <!-- Scripts -->

</body>

</html>