    <%- include('./navbar') %>

<!-- Success/Error Messages -->
<% if (typeof success !== 'undefined') { %>
<div style="background-color:#d1e7dd; color:#0f5132; border:1px solid #badbcc; padding:10px; border-radius:6px; margin-bottom:15px; position:relative;">
  <%= success %>
  <button type="button" onclick="this.parentElement.remove()" 
          style="position:absolute; right:10px; top:10px; background:none; border:none; font-size:16px; cursor:pointer;">√ó</button>
</div>
<% } %>

<% if (typeof error !== 'undefined') { %>
<div style="background-color:#f8d7da; color:#842029; border:1px solid #f5c2c7; padding:10px; border-radius:6px; margin-bottom:15px; position:relative;">
  <%= error %>
  <button type="button" onclick="this.parentElement.remove()" 
          style="position:absolute; right:10px; top:10px; background:none; border:none; font-size:16px; cursor:pointer;">√ó</button>
</div>
<% } %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
  <p style="color:#6c757d; margin:0;">Manage subscription plans and pricing</p>
  <button style="background-color:#0d6efd; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;"
          onclick="document.getElementById('createPlanModal').style.display='block'">
    ‚ûï Create New Plan
  </button>
</div>

<div style="background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:20px;">
  <div style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background-color:#f1f3f5; text-align:left;">
          <th style="padding:10px;">Plan Name</th>
          <th style="padding:10px;">Duration</th>
          <th style="padding:10px;">Price</th>
          <th style="padding:10px;">Active Subs</th>
          <th style="padding:10px;">Status</th>
          <th style="padding:10px;">Created</th>
          <th style="padding:10px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% plans.forEach(plan => { %>
        <tr style="border-bottom:1px solid #ddd;">
          <td style="padding:10px; font-weight:bold;"><%= plan.name %></td>
          <td style="padding:10px;"><span style="background:#0dcaf0; color:white; padding:3px 8px; border-radius:4px;"><%= plan.duration_days %> days</span></td>
          <td style="padding:10px;">‚Çπ<%= plan.price.toLocaleString() %></td>
          <td style="padding:10px;"><span style="background:#198754; color:white; padding:3px 8px; border-radius:4px;"><%= plan.subscriptions ? plan.subscriptions.filter(s => s.status === 'active').length : 0 %></span></td>
          <td style="padding:10px;">
            <% if (plan.is_active) { %>
              <span style="background:#198754; color:white; padding:3px 8px; border-radius:4px;">Active</span>
            <% } else { %>
              <span style="background:#6c757d; color:white; padding:3px 8px; border-radius:4px;">Inactive</span>
            <% } %>
          </td>
          <td style="padding:10px;"><%= new Date(plan.created_at).toLocaleDateString() %></td>
          <td style="padding:10px;">
            <div style="display:flex; gap:5px;">
              <!-- Edit Button -->
              <button onclick="editPlan(<%= plan.id %>, '<%= plan.name %>', <%= plan.duration_days %>, <%= plan.price %>, <%= plan.is_active %>)" 
                      style="border:1px solid #0d6efd; color:#0d6efd; background:none; padding:4px 8px; border-radius:4px; cursor:pointer;" 
                      title="Edit">‚úèÔ∏è</button>
              
              <!-- Toggle Active Status -->
              <form method="POST" action="/admin/subscription-plans/<%= plan.id %>/toggle" style="display:inline;" 
                    onsubmit="return confirm('Are you sure you want to <%= plan.is_active ? 'deactivate' : 'activate' %> this plan?')">
                <button type="submit" 
                        style="border:1px solid #ffc107; color:#ffc107; background:none; padding:4px 8px; border-radius:4px; cursor:pointer;" 
                        title="<%= plan.is_active ? 'Deactivate' : 'Activate' %>">
                  <%= plan.is_active ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è" %>
                </button>
              </form>
              
              <!-- Delete Button (only if no active subscriptions) -->
              <% const activeSubscriptions = plan.subscriptions ? plan.subscriptions.filter(s => s.status === 'active').length : 0; %>
              <% if (activeSubscriptions === 0) { %>
                <form method="POST" action="/admin/subscription-plans/<%= plan.id %>/delete" style="display:inline;" 
                      onsubmit="return confirm('Are you sure you want to delete this plan? This action cannot be undone.')">
                  <button type="submit" 
                          style="border:1px solid #dc3545; color:#dc3545; background:none; padding:4px 8px; border-radius:4px; cursor:pointer;" 
                          title="Delete">üóëÔ∏è</button>
                </form>
              <% } else { %>
                <button disabled 
                        style="border:1px solid #ccc; color:#ccc; background:none; padding:4px 8px; border-radius:4px; cursor:not-allowed;" 
                        title="Cannot delete - has active subscriptions">üóëÔ∏è</button>
              <% } %>
            </div>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>

<!-- Create Plan Modal -->
<div id="createPlanModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:400px; margin:10% auto; border-radius:8px; overflow:hidden;">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <h5 style="margin:0;">Create New Subscription Plan</h5>
      <button onclick="document.getElementById('createPlanModal').style.display='none'" 
              style="background:none; border:none; font-size:18px; cursor:pointer;">√ó</button>
    </div>
    <form action="/admin/subscription-plans/create" method="POST" style="padding:15px;">
      <div style="margin-bottom:10px;">
        <label>Plan Name *</label>
        <input type="text" name="name" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
        <small style="color:#6c757d;">e.g., "Plus Membership"</small>
      </div>
      <div style="margin-bottom:10px;">
        <label>Duration (Days) *</label>
        <input type="number" name="duration_days" value="365" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label>Price (‚Çπ) *</label>
        <input type="number" name="price" step="0.01" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label><input type="checkbox" name="is_active" checked> Active (available for purchase)</label>
      </div>
      <div style="text-align:right;">
        <button type="button" onclick="document.getElementById('createPlanModal').style.display='none'" 
                style="background:#6c757d; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cancel</button>
        <button type="submit" 
                style="background:#0d6efd; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Create Plan</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Plan Modal -->
<div id="editPlanModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:400px; margin:10% auto; border-radius:8px; overflow:hidden;">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <h5 style="margin:0;">Edit Subscription Plan</h5>
      <button onclick="document.getElementById('editPlanModal').style.display='none'" 
              style="background:none; border:none; font-size:18px; cursor:pointer;">√ó</button>
    </div>
    <form id="editPlanForm" method="POST" style="padding:15px;">
      <div style="margin-bottom:10px;">
        <label>Plan Name *</label>
        <input type="text" name="name" id="editPlanName" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label>Duration (Days) *</label>
        <input type="number" name="duration_days" id="editPlanDuration" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label>Price (‚Çπ) *</label>
        <input type="number" name="price" step="0.01" id="editPlanPrice" required style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom:10px;">
        <label><input type="checkbox" name="is_active" id="editPlanActive"> Active (available for purchase)</label>
      </div>
      <div style="text-align:right;">
        <button type="button" onclick="document.getElementById('editPlanModal').style.display='none'" 
                style="background:#6c757d; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Cancel</button>
        <button type="submit" 
                style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Update Plan</button>
      </div>
    </form>
  </div>
</div>

<script>
// Show messages from URL
const urlParams = new URLSearchParams(window.location.search);
const successMsg = urlParams.get('success');
const errorMsg = urlParams.get('error');

function showAlert(msg, color) {
  const div = document.createElement('div');
  div.style.cssText = `background-color:${color === 'success' ? '#d1e7dd':'#f8d7da'}; 
                       color:${color === 'success' ? '#0f5132':'#842029'};
                       border-radius:6px; padding:10px; margin-bottom:15px; position:relative;`;
  div.innerHTML = msg + `<button onclick="this.parentElement.remove()" 
                          style='position:absolute; right:10px; top:10px; background:none; border:none; cursor:pointer;'>√ó</button>`;
  document.body.prepend(div);
}

if (successMsg) showAlert(successMsg, 'success');
if (errorMsg) showAlert(errorMsg, 'error');

// Edit Plan Function
function editPlan(id, name, duration, price, isActive) {
  document.getElementById('editPlanForm').action = `/admin/subscription-plans/${id}/update`;
  document.getElementById('editPlanName').value = name;
  document.getElementById('editPlanDuration').value = duration;
  document.getElementById('editPlanPrice').value = price;
  document.getElementById('editPlanActive').checked = isActive;
  document.getElementById('editPlanModal').style.display = 'block';
}

// Close modals when clicking outside
window.onclick = function(event) {
  const createModal = document.getElementById('createPlanModal');
  const editModal = document.getElementById('editPlanModal');
  
  if (event.target === createModal) {
    createModal.style.display = 'none';
  }
  if (event.target === editModal) {
    editModal.style.display = 'none';
  }
}
</script>
