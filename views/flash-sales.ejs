    <%- include('./navbar') %>

<!-- Header Section -->

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
  <p style="color:#6c757d; margin:0;">Manage flash sales with dynamic tiers and member limits</p>
  <button onclick="document.getElementById('createFlashSaleModal').style.display='block'"
          style="background-color:#0d6efd; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-weight:500;">
    ‚ö° Create Flash Sale
  </button>
</div>

<!-- Flash Sales List -->
<div style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px;">
  <% flashSales.forEach((sale, index) => { %>
  <div style="flex:1 1 calc(50% - 20px); min-width:300px; border:2px solid 
    <%= sale.status === 'active' ? '#198754' : sale.status === 'ended' ? '#dc3545' : '#ffc107' %>;
    border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 style="margin:0 0 5px 0;"><%= sale.name %></h3>
        <small style="color:#6c757d;">Code: <strong><%= sale.code %></strong></small>
      </div>

      <!-- Actions Dropdown -->
      <div style="position:relative;">
        <button onclick="toggleDropdown(<%= index %>)"
                style="background:none; border:1px solid #ccc; padding:6px 10px; border-radius:4px; cursor:pointer;">
          <span style="background:<%= sale.status === 'active' ? '#198754' : sale.status === 'ended' ? '#dc3545' : '#ffc107' %>;
                       color:white; padding:3px 6px; border-radius:4px; font-size:12px;">
            <%= sale.status.toUpperCase() %>
          </span> ‚ñº
        </button>
        <ul id="dropdown-<%= index %>" 
            style="display:none; position:absolute; top:35px; right:0; background:white; border:1px solid #ccc; border-radius:6px; list-style:none; padding:5px 0; margin:0; width:160px; box-shadow:0 2px 8px rgba(0,0,0,0.1); z-index:100;">
          
          <!-- Status Changes -->
          <li style="border-bottom:1px solid #eee; margin-bottom:5px; padding-bottom:5px;">
            <strong style="padding:0 12px; color:#666; font-size:12px;">STATUS</strong>
          </li>
          <li>
            <form action="/admin/flash-sales/<%= sale.id %>/status" method="POST" style="margin:0;">
              <input type="hidden" name="status" value="scheduled">
              <button type="submit" style="width:100%; border:none; background:none; text-align:left; padding:8px 12px; cursor:pointer; color:#ffc107;">üìÖ Schedule</button>
            </form>
          </li>
          <li>
            <form action="/admin/flash-sales/<%= sale.id %>/status" method="POST" style="margin:0;">
              <input type="hidden" name="status" value="active">
              <button type="submit" style="width:100%; border:none; background:none; text-align:left; padding:8px 12px; cursor:pointer; color:#198754;">‚ñ∂Ô∏è Start Sale</button>
            </form>
          </li>
          <li>
            <form action="/admin/flash-sales/<%= sale.id %>/status" method="POST" style="margin:0;">
              <input type="hidden" name="status" value="ended">
              <button type="submit" style="width:100%; border:none; background:none; text-align:left; padding:8px 12px; cursor:pointer; color:#dc3545;">‚èπÔ∏è End Sale</button>
            </form>
          </li>
          
          <!-- Actions -->
          <li style="border-top:1px solid #eee; margin-top:5px; padding-top:5px;">
            <strong style="padding:0 12px; color:#666; font-size:12px;">ACTIONS</strong>
          </li>
          <li>
            <button onclick="openEditModal(<%= sale.id %>)" style="width:100%; border:none; background:none; text-align:left; padding:8px 12px; cursor:pointer; color:#0d6efd;">‚úèÔ∏è Edit</button>
          </li>
          <li>
            <button onclick="confirmDelete(<%= sale.id %>, '<%= sale.name %>')" style="width:100%; border:none; background:none; text-align:left; padding:8px 12px; cursor:pointer; color:#dc3545;">üóëÔ∏è Delete</button>
          </li>
        </ul>
      </div>
    </div>

    <div style="padding:15px;">
      <% if (sale.description) { %>
        <p style="color:#6c757d; margin:0 0 10px 0;"><%= sale.description %></p>
      <% } %>

      <!-- Timing Info -->
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <div>
          <small style="color:#6c757d;">Start Time</small>
          <div><strong><%= new Date(sale.start_time).toLocaleString() %></strong></div>
        </div>
        <div>
          <small style="color:#6c757d;">End Time</small>
          <div><strong><%= new Date(sale.end_time).toLocaleString() %></strong></div>
        </div>
      </div>

      <!-- Stats -->
      <div style="display:flex; justify-content:space-between; text-align:center; margin-bottom:10px;">
        <div>
          <div style="font-size:18px; color:#0d6efd;"><%= sale.statistics.total_slots %></div>
          <small style="color:#6c757d;">Total</small>
        </div>
        <div>
          <div style="font-size:18px; color:#198754;"><%= sale.statistics.used_slots %></div>
          <small style="color:#6c757d;">Used</small>
        </div>
        <div>
          <div style="font-size:18px; color:#ffc107;"><%= sale.statistics.remaining_slots %></div>
          <small style="color:#6c757d;">Left</small>
        </div>
        <div>
          <div style="font-size:18px; color:#0dcaf0;"><%= sale.statistics.utilization_percentage %>%</div>
          <small style="color:#6c757d;">Utilized</small>
        </div>
      </div>

      <!-- Progress Bar -->
      <div style="background:#e9ecef; height:8px; border-radius:4px; overflow:hidden; margin-bottom:10px;">
        <div style="width:<%= sale.statistics.utilization_percentage %>%; background:#198754; height:100%;"></div>
      </div>

      <!-- Discount Tiers -->
      <div>
        <h6 style="margin-bottom:6px;">Discount Tiers:</h6>
        <% sale.tiers.forEach(tier => { %>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <span style="background:<%= tier.status === 'active' ? '#0d6efd' : '#6c757d' %>; color:white; padding:3px 8px; border-radius:4px;">
              <%= tier.tier_name %> - <%= tier.discount_percent %>%
            </span>
            <small style="color:#6c757d;"><%= tier.used_count %>/<%= tier.member_limit %> used</small>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
  <% }); %>
</div>

<!-- Create Flash Sale Modal -->
<div id="createFlashSaleModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:80%; max-width:800px; margin:3% auto; border-radius:10px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.3); max-height:90vh; overflow-y:auto;">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <h4 style="margin:0;">‚ö° Create New Flash Sale</h4>
      <button onclick="document.getElementById('createFlashSaleModal').style.display='none'" 
              style="background:none; border:none; font-size:20px; cursor:pointer;">√ó</button>
    </div>

    <form action="/admin/flash-sales/create" method="POST" style="padding:20px;">
      <div style="display:flex; flex-wrap:wrap; gap:15px;">
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Sale Name *</label>
          <input type="text" name="name" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
        </div>
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Promo Code *</label>
          <input type="text" name="code" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; text-transform:uppercase;">
        </div>
        <div style="flex:1 1 100%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Description</label>
          <textarea name="description" rows="3" placeholder="Brief description of the flash sale..." style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; resize:vertical;"></textarea>
        </div>
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Start Time *</label>
          <input type="datetime-local" name="start_time" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
        </div>
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">End Time *</label>
          <input type="datetime-local" name="end_time" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
        </div>
      </div>

      <hr style="margin:25px 0;">
      <h5 style="margin-bottom:15px;">üéØ Discount Tiers</h5>
      <div id="tiersContainer">
        <div style="display:flex; gap:10px; margin-bottom:10px; align-items:end;">
          <div style="flex:1;">
            <small style="color:#6c757d;">Tier Name</small>
            <input type="text" name="tier_names" placeholder="e.g., Gold Tier" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div style="flex:1;">
            <small style="color:#6c757d;">Member Limit</small>
            <input type="number" name="member_limits" placeholder="100" min="1" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div style="flex:1;">
            <small style="color:#6c757d;">Discount %</small>
            <input type="number" name="discount_percents" placeholder="25" min="1" max="100" step="0.01" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <button type="button" onclick="removeTier(this)" style="background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
        </div>
      </div>

      <button type="button" onclick="addTier()" 
              style="background:#198754; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; margin-bottom:20px;">‚ûï Add Tier</button>

      <div style="text-align:right; border-top:1px solid #ddd; padding-top:15px;">
        <button type="button" onclick="document.getElementById('createFlashSaleModal').style.display='none'"
                style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; margin-right:10px;">Cancel</button>
        <button type="submit" style="background:#0d6efd; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-weight:600;">‚ö° Create Flash Sale</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Flash Sale Modal -->
<div id="editFlashSaleModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:80%; max-width:800px; margin:3% auto; border-radius:10px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.3); max-height:90vh; overflow-y:auto;">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
      <h4 style="margin:0;">‚úèÔ∏è Edit Flash Sale</h4>
      <button onclick="document.getElementById('editFlashSaleModal').style.display='none'" 
              style="background:none; border:none; font-size:20px; cursor:pointer;">√ó</button>
    </div>

    <form id="editFlashSaleForm" method="POST" style="padding:20px;">
      <div style="display:flex; flex-wrap:wrap; gap:15px;">
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Sale Name *</label>
          <input type="text" id="edit_name" name="name" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
        </div>
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Promo Code *</label>
          <input type="text" id="edit_code" name="code" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; text-transform:uppercase;">
        </div>
        <div style="flex:1 1 100%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Description</label>
          <textarea id="edit_description" name="description" rows="3" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; resize:vertical;"></textarea>
        </div>
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">Start Time *</label>
          <input type="datetime-local" id="edit_start_time" name="start_time" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
        </div>
        <div style="flex:1 1 48%;">
          <label style="display:block; margin-bottom:5px; font-weight:600;">End Time *</label>
          <input type="datetime-local" id="edit_end_time" name="end_time" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
        </div>
      </div>

      <hr style="margin:25px 0;">
      <h5 style="margin-bottom:15px;">üéØ Discount Tiers</h5>
      <div id="editTiersContainer">
        <!-- Tiers will be populated by JavaScript -->
      </div>

      <button type="button" onclick="addEditTier()" 
              style="background:#198754; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; margin-bottom:20px;">‚ûï Add Tier</button>

      <div style="text-align:right; border-top:1px solid #ddd; padding-top:15px;">
        <button type="button" onclick="document.getElementById('editFlashSaleModal').style.display='none'"
                style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; margin-right:10px;">Cancel</button>
        <button type="submit" style="background:#ffc107; color:#000; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-weight:600;">üíæ Update Flash Sale</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; width:90%; max-width:500px; margin:15% auto; border-radius:10px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
    <div style="padding:20px; text-align:center;">
      <div style="font-size:48px; color:#dc3545; margin-bottom:15px;">üóëÔ∏è</div>
      <h4 style="margin:0 0 10px 0; color:#dc3545;">Delete Flash Sale</h4>
      <p style="color:#6c757d; margin-bottom:20px;">
        Are you sure you want to delete <strong id="deleteFlashSaleName"></strong>?<br>
        <small>This action cannot be undone and will remove all associated data.</small>
      </p>
      
      <div style="display:flex; gap:10px; justify-content:center;">
        <button onclick="document.getElementById('deleteConfirmModal').style.display='none'"
                style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Cancel</button>
        <form id="deleteFlashSaleForm" method="POST" style="display:inline;">
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" style="background:#dc3545; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:600;">üóëÔ∏è Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Flash Sale Data for JavaScript (populate this from server-side)
const flashSalesData = <%- JSON.stringify(flashSales) %>;

function toggleDropdown(i) {
  // Close all other dropdowns
  document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
    if (dropdown.id !== `dropdown-${i}`) {
      dropdown.style.display = 'none';
    }
  });
  
  const dropdown = document.getElementById('dropdown-' + i);
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
  if (!event.target.closest('button[onclick^="toggleDropdown"]')) {
    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
      dropdown.style.display = 'none';
    });
  }
});

function addTier() {
  const container = document.getElementById('tiersContainer');
  const row = document.createElement('div');
  row.style.cssText = "display:flex; gap:10px; margin-bottom:10px; align-items:end;";
  row.innerHTML = `
    <div style="flex:1;">
      <small style="color:#6c757d;">Tier Name</small>
      <input type="text" name="tier_names" placeholder="e.g., Silver Tier" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
    </div>
    <div style="flex:1;">
      <small style="color:#6c757d;">Member Limit</small>
      <input type="number" name="member_limits" placeholder="200" min="1" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
    </div>
    <div style="flex:1;">
      <small style="color:#6c757d;">Discount %</small>
      <input type="number" name="discount_percents" placeholder="15" min="1" max="100" step="0.01" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
    </div>
    <button type="button" onclick="removeTier(this)" style="background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
  `;
  container.appendChild(row);
}

function removeTier(btn) {
  const rows = document.querySelectorAll('#tiersContainer > div');
  if (rows.length > 1) btn.parentElement.remove();
}

function addEditTier() {
  const container = document.getElementById('editTiersContainer');
  const row = document.createElement('div');
  row.style.cssText = "display:flex; gap:10px; margin-bottom:10px; align-items:end;";
  row.innerHTML = `
    <div style="flex:1;">
      <small style="color:#6c757d;">Tier Name</small>
      <input type="text" name="tier_names" placeholder="e.g., Silver Tier" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
    </div>
    <div style="flex:1;">
      <small style="color:#6c757d;">Member Limit</small>
      <input type="number" name="member_limits" placeholder="200" min="1" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
    </div>
    <div style="flex:1;">
      <small style="color:#6c757d;">Discount %</small>
      <input type="number" name="discount_percents" placeholder="15" min="1" max="100" step="0.01" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
    </div>
    <button type="button" onclick="removeEditTier(this)" style="background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
  `;
  container.appendChild(row);
}

function removeEditTier(btn) {
  btn.parentElement.remove();
}

function openEditModal(flashSaleId) {
  const flashSale = flashSalesData.find(sale => sale.id === flashSaleId);
  if (!flashSale) return;

  // Populate form fields
  document.getElementById('edit_name').value = flashSale.name;
  document.getElementById('edit_code').value = flashSale.code;
  document.getElementById('edit_description').value = flashSale.description || '';
  
  // Format dates for datetime-local input
  document.getElementById('edit_start_time').value = new Date(flashSale.start_time).toISOString().slice(0, 16);
  document.getElementById('edit_end_time').value = new Date(flashSale.end_time).toISOString().slice(0, 16);

  // Set form action
  document.getElementById('editFlashSaleForm').action = `/admin/flash-sales/${flashSaleId}/update`;

  // Populate tiers
  const tiersContainer = document.getElementById('editTiersContainer');
  tiersContainer.innerHTML = '';
  
  flashSale.tiers.forEach(tier => {
    const row = document.createElement('div');
    row.style.cssText = "display:flex; gap:10px; margin-bottom:10px; align-items:end;";
    row.innerHTML = `
      <div style="flex:1;">
        <small style="color:#6c757d;">Tier Name</small>
        <input type="text" name="tier_names" value="${tier.tier_name}" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        <input type="hidden" name="tier_ids" value="${tier.id}">
      </div>
      <div style="flex:1;">
        <small style="color:#6c757d;">Member Limit</small>
        <input type="number" name="member_limits" value="${tier.member_limit}" min="1" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="flex:1;">
        <small style="color:#6c757d;">Discount %</small>
        <input type="number" name="discount_percents" value="${tier.discount_percent}" min="1" max="100" step="0.01" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
      </div>
      <button type="button" onclick="removeEditTier(this)" style="background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
    `;
    tiersContainer.appendChild(row);
  });

  // Show modal
  document.getElementById('editFlashSaleModal').style.display = 'block';
}

function confirmDelete(flashSaleId, flashSaleName) {
  document.getElementById('deleteFlashSaleName').textContent = flashSaleName;
  document.getElementById('deleteFlashSaleForm').action = `/admin/flash-sales/${flashSaleId}/delete`;
  document.getElementById('deleteConfirmModal').style.display = 'block';
}
</script>
